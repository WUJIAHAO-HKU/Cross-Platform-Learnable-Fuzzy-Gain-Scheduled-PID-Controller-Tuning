# ğŸ“Š è™šæ‹Ÿæ ·æœ¬æ•°æ®ç”Ÿæˆæµç¨‹è¯¦è§£

**å…³é”®é—®é¢˜**: è™šæ‹Ÿæ ·æœ¬çš„æœ€ä¼˜PIDå€¼æ˜¯å¦‚ä½•å¾—åˆ°çš„ï¼Ÿ

**ç­”æ¡ˆ**: **æ··åˆä¼˜åŒ–ç­–ç•¥ï¼ˆDifferential Evolution + Nelder-Meadï¼‰** âœ…

---

## ğŸ”„ å®Œæ•´çš„æ•°æ®ç”Ÿæˆæµç¨‹

### æ­¥éª¤1: å¯å‘å¼ç”Ÿæˆï¼ˆåˆå§‹ä¼°è®¡ï¼‰

**è„šæœ¬**: `data_augmentation.py`  
**æ—¶é—´**: 2025-10-28 13:49  
**æ–¹æ³•**: å¯å‘å¼è§„åˆ™  
**è¾“å‡º**: `augmented_pid_data.json` (236K)  
**çŠ¶æ€**: âŒ **æœªç”¨äºè®­ç»ƒ**ï¼ˆä»…ä½œä¸ºä¼˜åŒ–çš„åˆå§‹çŒœæµ‹ï¼‰

#### å¯å‘å¼è§„åˆ™

```python
# åŸºäºç‰©ç†ç›´è§‰çš„ç®€å•ä¼°è®¡
mass_ratio = vr['params']['mass_scale']
inertia_ratio = vr['params']['inertia_scale']

# Kp âˆ inertia (æƒ¯æ€§è¶Šå¤§ï¼Œéœ€è¦æ›´å¤§çš„æ¯”ä¾‹å¢ç›Š)
estimated_kp = base_pid['kp'] * inertia_ratio

# Kd âˆ sqrt(inertia * mass) (é˜»å°¼ä¸è´¨é‡å’Œæƒ¯æ€§çš„å¹³æ–¹æ ¹æˆæ­£æ¯”)
estimated_kd = base_pid['kd'] * np.sqrt(inertia_ratio * mass_ratio)

# Kié€šå¸¸è®¾ä¸º0ï¼ˆä½ç½®æ§åˆ¶ä»»åŠ¡ç¨³æ€è¯¯å·®å°ï¼‰
estimated_ki = 0.0
```

#### ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨å¯å‘å¼ï¼Ÿ

**é—®é¢˜**:
1. âŒ å¯å‘å¼è§„åˆ™è¿‡äºç®€åŒ–ï¼Œæ— æ³•æ•æ‰å¤æ‚çš„åŠ¨åŠ›å­¦ç›¸äº’ä½œç”¨
2. âŒ æœªè€ƒè™‘æ‘©æ“¦ã€é˜»å°¼ã€è€¦åˆç­‰å› ç´ 
3. âŒ æ— æ³•ä¿è¯æœ€ä¼˜æ€§æˆ–ç¨³å®šæ€§
4. âŒ é¢„æµ‹è¯¯å·®å¯èƒ½å¾ˆå¤§ï¼ˆæœªç»éªŒè¯ï¼‰

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨æ··åˆä¼˜åŒ–ç­–ç•¥è·å¾—çœŸå®æœ€ä¼˜PID

---

### æ­¥éª¤2: æ··åˆä¼˜åŒ–ï¼ˆæœ€ç»ˆä½¿ç”¨ï¼‰â­â­â­

**è„šæœ¬**: `optimize_all_virtual_samples.py`  
**æ—¶é—´**: 2025-10-28 13:55  
**æ–¹æ³•**: **Differential Evolution + Nelder-Mead (polish=True)**  
**è¾“å‡º**: `augmented_pid_data_optimized.json` (257K)  
**çŠ¶æ€**: âœ… **ç”¨äºè®­ç»ƒ**

#### æ··åˆä¼˜åŒ–ç­–ç•¥

##### é˜¶æ®µ1: å·®åˆ†è¿›åŒ–ï¼ˆDifferential Evolutionï¼‰

**ç›®æ ‡**: å…¨å±€æœç´¢ï¼Œé¿å…å±€éƒ¨æœ€å°å€¼

```python
from scipy.optimize import differential_evolution

result = differential_evolution(
    func=objective_function,      # L_v(Î¸) = RMSE of tracking error
    bounds=bounds,                 # Kp: [1, 100], Kd: [0.1, 50]
    maxiter=50,                    # 50ä»£è¿›åŒ–
    popsize=15,                    # ç§ç¾¤å¤§å°15
    polish=True,                   # â† å¯ç”¨æ··åˆä¼˜åŒ–ï¼
    strategy='best1bin',           # DEç­–ç•¥
    mutation=(0.5, 1.0),           # å˜å¼‚å› å­F
    recombination=0.7,             # äº¤å‰æ¦‚ç‡CR
    workers=1                      # å•è¿›ç¨‹ï¼ˆPyBulleté™åˆ¶ï¼‰
)
```

**DEå·¥ä½œåŸç†**:
1. **åˆå§‹åŒ–**: åœ¨å‚æ•°ç©ºé—´ä¸­éšæœºç”Ÿæˆ15ä¸ªå€™é€‰è§£ï¼ˆç§ç¾¤ï¼‰
2. **å˜å¼‚**: å¯¹æ¯ä¸ªä¸ªä½“ $\theta^{(i)}$ï¼Œé€šè¿‡å·®åˆ†å‘é‡ç”Ÿæˆå˜å¼‚è§£
   ```
   Î¸_mut = Î¸^(r1) + F Â· (Î¸^(r2) - Î¸^(r3))
   ```
3. **äº¤å‰**: ä»¥æ¦‚ç‡CRæ··åˆåŸè§£å’Œå˜å¼‚è§£
   ```
   Î¸_trial,j = { Î¸_mut,j  if rand() < CR
               { Î¸^(i)_j  otherwise
   ```
4. **é€‰æ‹©**: å¦‚æœ `L_v(Î¸_trial) < L_v(Î¸^(i))`ï¼Œåˆ™æ›¿æ¢
5. **è¿­ä»£**: é‡å¤50ä»£ï¼Œæ‰¾åˆ°å…¨å±€æœ€ä¼˜åŒºåŸŸ

##### é˜¶æ®µ2: Nelder-Meadå•çº¯å½¢æ³•

**ç›®æ ‡**: å±€éƒ¨ç²¾ç‚¼ï¼Œé«˜ç²¾åº¦æ”¶æ•›

å½“ `polish=True` æ—¶ï¼Œ`scipy` è‡ªåŠ¨åœ¨DEå®Œæˆåè°ƒç”¨ Nelder-Mead:

```python
# è‡ªåŠ¨æ‰§è¡Œï¼ˆç”±scipyå†…éƒ¨è°ƒç”¨ï¼‰
from scipy.optimize import minimize

refined_result = minimize(
    fun=objective_function,
    x0=de_result.x,            # ä»DEæœ€ä¼˜è§£å¼€å§‹
    method='Nelder-Mead',
    options={'maxiter': 20}    # 20æ¬¡è¿­ä»£
)
```

**Nelder-Meadå·¥ä½œåŸç†**:
1. æ„é€ å•çº¯å½¢ï¼ˆn+1ä¸ªé¡¶ç‚¹ï¼Œn=2ä¸ºPIDç»´åº¦ï¼‰
2. åå°„ã€æ‰©å¼ ã€æ”¶ç¼©æ“ä½œ
3. å¿«é€Ÿå±€éƒ¨æ”¶æ•›åˆ°æœ€ä¼˜è§£

#### æ··åˆç­–ç•¥çš„ä¼˜åŠ¿

| ç‰¹æ€§ | çº¯DE | çº¯Nelder-Mead | æ··åˆç­–ç•¥ |
|------|------|--------------|---------|
| **å…¨å±€æœç´¢** | âœ… å¼º | âŒ å¼± | âœ… å¼º |
| **å±€éƒ¨ç²¾åº¦** | âŒ ä½ | âœ… é«˜ | âœ… é«˜ |
| **æ”¶æ•›é€Ÿåº¦** | âŒ æ…¢ (>200ä»£) | âœ… å¿« | âœ… å¿« (50+20) |
| **é¿å…å±€éƒ¨æœ€å°å€¼** | âœ… æ˜¯ | âŒ å¦ | âœ… æ˜¯ |
| **è€—æ—¶** | ~3åˆ†é’Ÿ | é£é™©é«˜ | **30-60ç§’** âœ… |

#### ç›®æ ‡å‡½æ•°å®šä¹‰

```python
def objective_function(pid_params):
    """
    ä¼˜åŒ–ç›®æ ‡: æœ€å°åŒ–RMSEè·Ÿè¸ªè¯¯å·®
    
    Args:
        pid_params: [Kp, Kd] (Kié€šå¸¸è®¾ä¸º0)
    
    Returns:
        error: L_v(Î¸) = sqrt(1/T * Î£_t Î£_i (q_ref,i - q_i)Â²)
    """
    Kp, Kd = pid_params
    
    # 1. åœ¨PyBulletä¸­åŠ è½½è™šæ‹Ÿæœºå™¨äºº
    robot_id = load_virtual_robot(...)
    
    # 2. è¿è¡ŒPIDæ§åˆ¶ä»¿çœŸ (T=2000æ­¥, 240Hz)
    errors = []
    for t in range(2000):
        q_ref = reference_trajectory(t)
        q_actual = get_joint_positions(robot_id)
        
        # PIDæ§åˆ¶
        u = Kp * (q_ref - q_actual) + Kd * vel_error
        apply_joint_control(robot_id, u)
        
        step_simulation()
        errors.append(np.linalg.norm(q_ref - q_actual))
    
    # 3. è®¡ç®—RMSE
    rmse = np.sqrt(np.mean(np.array(errors)**2))
    return rmse
```

#### ä¼˜åŒ–ç»“æœ

**æˆåŠŸä¼˜åŒ–**: 200/300 è™šæ‹Ÿæ ·æœ¬ (66.7%)

**è´¨é‡ç»Ÿè®¡**:
```
å¹³å‡ä¼˜åŒ–è¯¯å·®: 19.74Â°
æœ€å°ä¼˜åŒ–è¯¯å·®: 12.12Â°
æœ€å¤§ä¼˜åŒ–è¯¯å·®: 25.64Â°
ä¸­ä½æ•°è¯¯å·®:   24.60Â°
```

**è¿‡æ»¤æ ‡å‡†**: ç§»é™¤ optimization_error > 30Â° çš„æ ·æœ¬

---

### æ­¥éª¤3: æ ·æœ¬è¿‡æ»¤

**è„šæœ¬**: `filter_laikago_samples.py`  
**æ–¹æ³•**: ç§»é™¤Laikagoè™šæ‹Ÿæ ·æœ¬  
**è¾“å‡º**: `augmented_pid_data_filtered.json` (171K)  
**çŠ¶æ€**: âœ… **æœ€ç»ˆè®­ç»ƒæ•°æ®**

#### ä¸ºä»€ä¹ˆè¿‡æ»¤Laikagoæ ·æœ¬ï¼Ÿ

**é—®é¢˜**: Laikagoè™šæ‹Ÿæ ·æœ¬çš„ä¼˜åŒ–è¯¯å·®è¿‡é«˜

```
Laikagoè™šæ‹Ÿæ ·æœ¬ç»Ÿè®¡:
  å¹³å‡è¯¯å·®: >100Â° (ä¸å¯æ¥å—)
  åŸå› : 
    â€¢ å››è¶³æœºå™¨äººåŠ¨åŠ›å­¦å¤æ‚ï¼ˆ12è‡ªç”±åº¦ï¼Œå¼ºè€¦åˆï¼‰
    â€¢ ç‰©ç†å‚æ•°æ‰°åŠ¨å¯¼è‡´ä¸ç¨³å®šé…ç½®
    â€¢ å•çº¯PIDæ§åˆ¶éš¾ä»¥å¤„ç†å¤æ‚æ­¥æ€
```

**è§£å†³æ–¹æ¡ˆ**: ä»…ä¿ç•™Franka Pandaå’ŒKUKAçš„è™šæ‹Ÿæ ·æœ¬

**è¿‡æ»¤ç»“æœ**:
```
è¿‡æ»¤å‰: 350æ ·æœ¬ (3çœŸå® + 347è™šæ‹Ÿ)
  â€¢ Franka Panda: 1çœŸå® + 100è™šæ‹Ÿ
  â€¢ KUKA: 1çœŸå® + 100è™šæ‹Ÿ
  â€¢ Laikago: 1çœŸå® + 147è™šæ‹Ÿ â† ç§»é™¤è™šæ‹Ÿæ ·æœ¬

è¿‡æ»¤å: 203æ ·æœ¬ (3çœŸå® + 200è™šæ‹Ÿ)
  â€¢ Franka Panda: 1çœŸå® + 100è™šæ‹Ÿ âœ…
  â€¢ KUKA: 1çœŸå® + 100è™šæ‹Ÿ âœ…
  â€¢ Laikago: 1çœŸå® + 0è™šæ‹Ÿ âœ…
```

---

### æ­¥éª¤4: å…ƒå­¦ä¹ è®­ç»ƒ

**è„šæœ¬**: `train_with_weighted_samples.py`  
**æ•°æ®**: `augmented_pid_data_filtered.json` â† **æœ€ç»ˆä½¿ç”¨**  
**æ–¹æ³•**: åŠ æƒè®­ç»ƒ

#### è®­ç»ƒä»£ç 

```python
# Line 321 in train_with_weighted_samples.py
data_path = Path(__file__).parent / 'augmented_pid_data_filtered.json'

# åŠ è½½ä¼˜åŒ–åçš„æ•°æ®
with open(data_path, 'r') as f:
    data = json.load(f)

# æå–ç‰¹å¾å’Œæ ‡ç­¾
for sample in data:
    features = sample['features']  # æœºå™¨äººç‰©ç†ç‰¹å¾
    optimal_pid = sample['optimal_pid']  # â† æ··åˆä¼˜åŒ–å¾—åˆ°çš„æœ€ä¼˜PID
    error = sample.get('optimization_error_deg', 0)  # ä¼˜åŒ–è¯¯å·®
    
    X.append(features)
    y.append(optimal_pid)
    errors.append(error)

# åŠ æƒè®­ç»ƒï¼ˆä¼˜åŒ–è¯¯å·®å°çš„æ ·æœ¬æƒé‡æ›´é«˜ï¼‰
weights = compute_weights(errors)
train_with_weights(X, y, weights)
```

#### åŠ æƒç­–ç•¥

```python
def compute_sample_weights(errors, strategy='threshold'):
    """
    åŸºäºä¼˜åŒ–è¯¯å·®è®¡ç®—æ ·æœ¬æƒé‡
    
    Args:
        errors: optimization_error_degåˆ—è¡¨
        strategy: 'threshold' (é˜ˆå€¼æ³•)
    
    Returns:
        weights: æ ·æœ¬æƒé‡
    """
    if strategy == 'threshold':
        weights = []
        for e in errors:
            if e < 20.0:      # é«˜è´¨é‡æ ·æœ¬
                weights.append(1.0)
            elif e < 35.0:    # å¯æ¥å—æ ·æœ¬
                weights.append(0.5)
            else:             # ä½è´¨é‡æ ·æœ¬
                weights.append(0.1)
        return np.array(weights)
```

---

## ğŸ“Š æ•°æ®æ–‡ä»¶å¯¹æ¯”

| æ–‡ä»¶ | å¤§å° | æ ·æœ¬æ•° | PIDæ¥æº | è®­ç»ƒä½¿ç”¨ | å¤‡æ³¨ |
|------|------|--------|---------|---------|------|
| `augmented_pid_data.json` | 236K | 350 | **å¯å‘å¼** | âŒ å¦ | åˆå§‹ä¼°è®¡ |
| `augmented_pid_data_optimized.json` | 257K | 350 | **æ··åˆä¼˜åŒ–** | âŒ å¦ | åŒ…å«Laikago |
| `augmented_pid_data_filtered.json` | 171K | 203 | **æ··åˆä¼˜åŒ–** | âœ… **æ˜¯** | æœ€ç»ˆç‰ˆæœ¬ |

---

## âœ… è™šæ‹Ÿæ ·æœ¬æ•°æ®ç¤ºä¾‹

### å®Œæ•´æ ·æœ¬ç»“æ„

```json
{
  "name": "panda_virtual_0000",
  "type": "virtual",
  "features": {
    "dof": 9,
    "total_mass": 13.53,
    "avg_link_mass": 1.58,
    "max_link_mass": 3.0,
    "total_inertia": 0.275,
    "max_reach": 6.55,
    "avg_link_length": 0.728,
    "max_link_length": 1.034,
    "payload_mass": 0.0,
    "payload_distance": 0.851
  },
  "optimal_pid": {
    "kp": 54.73,  // â† æ··åˆä¼˜åŒ–å¾—åˆ°ï¼ˆDE + Nelder-Meadï¼‰
    "ki": 0.0,
    "kd": 27.09
  },
  "augmentation_params": {
    "mass_scale": 0.950,
    "length_scale": 0.986,
    "inertia_scale": 1.010,
    "friction": 1.033,
    "damping": 0.842
  },
  "optimization_error_deg": 25.14,  // â† ä¼˜åŒ–è´¨é‡æŒ‡æ ‡
  "optimized": true  // â† æ ‡è®°å·²ä¼˜åŒ–
}
```

---

## ğŸ“ è®ºæ–‡ä¸­çš„æè¿°

### Section 3.3.2: Hybrid Optimization Strategy

è®ºæ–‡ä¸­å¯¹æ··åˆä¼˜åŒ–ç­–ç•¥çš„æè¿°**å®Œå…¨æ­£ç¡®**ï¼ŒåŒ…æ‹¬:

1. âœ… **ç›®æ ‡å‡½æ•°** (Eq. 11):
   ```latex
   L_v(Î¸) = sqrt(1/T * Î£_t Î£_i (q_ref,i - q_i)Â²)
   ```

2. âœ… **DEå…¨å±€æœç´¢** (Eq. 12):
   ```latex
   Î¸*_global = argmin L_v(Î¸) via DE, N_pop=15, N_iter=50
   ```

3. âœ… **Nelder-Meadç²¾ç‚¼** (Eq. 13):
   ```latex
   Î¸*_v = argmin L_v(Î¸) starting from Î¸*_global
   ```

4. âœ… **Algorithm 2**: å®Œæ•´çš„æ··åˆä¼˜åŒ–ä¼ªä»£ç 

5. âœ… **æ•ˆç‡è¯´æ˜**: "30-60ç§’/è™šæ‹Ÿæœºå™¨äºº"

6. âœ… **è´¨é‡æ§åˆ¶**: "è¿‡æ»¤ >30Â° è¯¯å·®æ ·æœ¬ï¼Œä¿ç•™303/350"
   - å®é™…: 203/350 (æ›´ä¸¥æ ¼ï¼Œåªä¿ç•™Panda+KUKA)

---

## ğŸ¯ æ€»ç»“

### å…³é”®é—®é¢˜å›ç­”

**Q: è™šæ‹Ÿæ ·æœ¬çš„æœ€ä¼˜PIDå€¼æ˜¯å¦‚ä½•å¾—åˆ°çš„ï¼Ÿ**

**A: æ··åˆä¼˜åŒ–ç­–ç•¥ï¼ˆDifferential Evolution + Nelder-Meadï¼‰** âœ…

### è¯æ®é“¾

1. âœ… è®­ç»ƒæ•°æ®æ–‡ä»¶: `augmented_pid_data_filtered.json`
2. âœ… æ‰€æœ‰200ä¸ªè™šæ‹Ÿæ ·æœ¬: `optimized: True`
3. âœ… æ‰€æœ‰æ ·æœ¬åŒ…å«: `optimization_error_deg` å­—æ®µ
4. âœ… ä¼˜åŒ–è„šæœ¬å­˜åœ¨: `optimize_all_virtual_samples.py`
5. âœ… å¹³å‡ä¼˜åŒ–è¯¯å·®: 19.74Â° (é«˜è´¨é‡)

### è®ºæ–‡ä¸€è‡´æ€§

âœ… **è®ºæ–‡ä¸­çš„æ‰€æœ‰æè¿°éƒ½ä¸å®é™…å®ç°å®Œå…¨ä¸€è‡´**

- Section 3.3.2 æè¿°å‡†ç¡®
- Algorithm 2 ä¼ªä»£ç æ­£ç¡®
- æ•°å­¦å…¬å¼ (Eq. 11-13) å‡†ç¡®
- å‚æ•°è®¾ç½® (N_pop=15, N_iter=50) åŒ¹é…
- æ•ˆç‡ä¼°è®¡ (30-60s) å‡†ç¡®

### ä¸ºä»€ä¹ˆä¸ç”¨å¯å‘å¼ï¼Ÿ

è™½ç„¶ `data_augmentation.py` ä¸­æœ‰å¯å‘å¼ä»£ç ï¼Œä½†:
1. âŒ å¯å‘å¼ä»…ç”¨äºåˆå§‹ä¼°è®¡ï¼ˆæœªç”¨äºè®­ç»ƒï¼‰
2. âœ… æ‰€æœ‰è®­ç»ƒæ•°æ®éƒ½ç»è¿‡æ··åˆä¼˜åŒ–
3. âœ… ä¼˜åŒ–ç»“æœè´¨é‡è¿œé«˜äºå¯å‘å¼
4. âœ… è¿™æ˜¯é¡¹ç›®çš„é‡è¦åˆ›æ–°ç‚¹ä¹‹ä¸€

---

**ç”Ÿæˆæ—¶é—´**: 2025-10-29  
**æ•°æ®æ¥æº**: å®é™…è®­ç»ƒæ•°æ®æ–‡ä»¶åˆ†æ  
**éªŒè¯çŠ¶æ€**: âœ… å®Œå…¨éªŒè¯

