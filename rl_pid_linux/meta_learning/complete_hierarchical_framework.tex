% Complete Hierarchical Meta-Learning Framework
% 完整的三阶段训练流程可视化
% 编译: pdflatex complete_hierarchical_framework.tex

\documentclass[border=8pt, multi, tikz]{standalone}
\usepackage{import}
\usepackage{tikz}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{bm}

\usetikzlibrary{positioning, shapes.geometric, arrows.meta, calc, shadows, decorations.pathreplacing, fit, backgrounds}

% 定义颜色
\definecolor{phase1color}{RGB}{52, 152, 219}
\definecolor{phase2color}{RGB}{231, 76, 60}
\definecolor{phase3color}{RGB}{39, 174, 96}
\definecolor{robotcolor}{RGB}{243, 156, 18}

\begin{document}
\begin{tikzpicture}[
    font=\sffamily,
    >=Stealth,
    node distance=0.8cm,
    box/.style={rectangle, rounded corners, draw=black, thick, minimum width=2cm, minimum height=1.2cm, align=center, drop shadow, fill=#1},
    smallbox/.style={rectangle, rounded corners, draw=black, thick, minimum width=1.5cm, minimum height=0.8cm, align=center, fill=#1},
    robot/.style={rectangle, rounded corners=8pt, draw=black, very thick, minimum width=1.8cm, minimum height=1.5cm, align=center, fill=#1, drop shadow},
    arrow/.style={->, ultra thick, >=Stealth},
    bigarrow/.style={->, ultra thick, >=Stealth, line width=3pt},
    phasebox/.style={rectangle, rounded corners=15pt, draw=black, ultra thick, dashed, minimum width=18cm, minimum height=7cm, align=center, fill=#1!5},
]

%============================================================================
% Main Title
%============================================================================
\node[font=\sffamily\Huge\bfseries] at (0, 14) 
    {Hierarchical Meta-Learning Framework};
\node[font=\sffamily\Large, text=gray] at (0, 13)
    {Cross-Platform PID Control with Online Adaptation};

%============================================================================
% PHASE 1: Data Augmentation
%============================================================================
\begin{scope}[shift={(-8, 7)}]
    % Phase框
    \node[phasebox=phase1color, minimum width=6cm, minimum height=5cm] at (0, 0) {};
    \node[font=\Large\bfseries, text=phase1color] at (0, 2.3) {Phase 1};
    \node[font=\large, text=phase1color!80] at (0, 1.8) {Data Augmentation};
    
    % 3个Base Robots
    \node[robot=robotcolor!80, font=\small\bfseries] (franka) at (-1.5, 0.5) 
        {Franka\\Panda\\9-DOF};
    \node[robot=robotcolor!70, font=\small\bfseries] (kuka) at (0, 0.5)
        {KUKA\\LBR iiwa\\7-DOF};
    \node[robot=robotcolor!60, font=\small\bfseries] (laikago) at (1.5, 0.5)
        {Laikago\\Quadruped\\12-DOF};
    
    % 扰动操作
    \node[smallbox=blue!30, font=\scriptsize] at (0, -0.8) {Physics-Based\\Perturbation};
    
    % 箭头
    \draw[arrow, robotcolor] (franka) -- (0, -0.4);
    \draw[arrow, robotcolor] (kuka) -- (0, -0.4);
    \draw[arrow, robotcolor] (laikago) -- (0, -0.4);
    
    % 生成结果
    \node[box=phase1color!70, font=\Large\bfseries, minimum width=3cm] at (0, -2) 
        {\textcolor{white}{303}\\[-0.1cm]\small\textcolor{white}{Virtual Robots}};
    
    \draw[arrow, blue!70] (0, -1.2) -- (0, -1.6);
    
    % 详细信息
    \node[font=\tiny, align=center, text=gray] at (0, -2.8)
        {Mass, Inertia, Friction\\Link Lengths, COM};
\end{scope}

%============================================================================
% Arrow to Phase 2
%============================================================================
\draw[bigarrow, phase1color] (-5, 5) -- (-3, 3.5);
\node[font=\small, fill=white] at (-3.5, 4.5) {Robot Features};

%============================================================================
% PHASE 2: Meta-Learning
%============================================================================
\begin{scope}[shift={(0, 0)}]
    % Phase框
    \node[phasebox=phase2color, minimum width=10cm, minimum height=11cm] at (0, 0) {};
    \node[font=\Large\bfseries, text=phase2color] at (0, 5.2) {Phase 2};
    \node[font=\large, text=phase2color!80] at (0, 4.7) {Meta-PID Network Training};
    
    % 混合优化（顶部）
    \node[box=orange!70, font=\small\bfseries, minimum width=4cm] at (0, 3.8)
        {Hybrid Optimization\\(DE + Nelder-Mead)};
    \node[font=\tiny, text=gray, align=center] at (0, 3.1)
        {Ground Truth PID for each robot};
    
    % 训练数据准备
    \node[smallbox=blue!30, font=\scriptsize, minimum width=3.5cm] at (-2.5, 2)
        {Input: Robot\\Features (10D)};
    \node[smallbox=green!30, font=\scriptsize, minimum width=3.5cm] at (2.5, 2)
        {Label: Optimal\\$K_p, K_i, K_d$};
    
    % 神经网络层
    \node[box=phase2color!80, font=\small, minimum height=0.8cm] (enc1) at (0, 0.5)
        {Encoder 1 (256D)};
    \node[box=phase2color!80, font=\small, minimum height=0.8cm] (enc2) at (0, -0.5)
        {Encoder 2 (256D)};
    \node[box=phase2color!70, font=\small, minimum height=0.8cm] (hidden) at (0, -1.5)
        {Hidden (128D)};
    
    % 输出头
    \node[box=green!70, font=\scriptsize, minimum width=1.5cm, minimum height=0.6cm] (kp) at (-1.5, -2.7)
        {$K_p$ Head};
    \node[box=green!70, font=\scriptsize, minimum width=1.5cm, minimum height=0.6cm] (ki) at (0, -2.7)
        {$K_i$ Head};
    \node[box=green!70, font=\scriptsize, minimum width=1.5cm, minimum height=0.6cm] (kd) at (1.5, -2.7)
        {$K_d$ Head};
    
    % 连接箭头
    \draw[arrow, blue] (-2.5, 1.5) -- (enc1);
    \draw[arrow] (enc1) -- (enc2);
    \draw[arrow] (enc2) -- (hidden);
    \draw[arrow] (hidden) -- (kp);
    \draw[arrow] (hidden) -- (ki);
    \draw[arrow] (hidden) -- (kd);
    
    % 损失函数
    \node[box=yellow!50, font=\footnotesize, minimum width=4.5cm, minimum height=1cm] at (0, -4)
        {$\mathcal{L}_{meta} = \frac{1}{N}\sum_{v=1}^N \|\bm{\theta}_v^* - \hat{\bm{\theta}}_v\|_2^2$};
    
    \draw[arrow, green!70] (2.5, 1.5) -- (2.5, -3.5) -- (0, -3.5);
    \draw[arrow, green!70] (kp) -- (-1, -3.5) -- (0, -3.5);
    \draw[arrow, green!70] (ki) -- (0, -3.5);
    \draw[arrow, green!70] (kd) -- (1, -3.5) -- (0, -3.5);
    
    % 训练统计
    \node[font=\tiny, align=left, text=gray] at (-3.5, -4.8)
        {\textbf{Training:}\\Epochs: 1000\\Time: 8 min\\Loss: 0.0234};
    \node[font=\tiny, align=left, text=gray] at (3.5, -4.8)
        {\textbf{Result:}\\MAE: 2.88°\\vs Heuristic\\92\% better};
\end{scope}

%============================================================================
% Arrow to Phase 3
%============================================================================
\draw[bigarrow, phase2color] (5, -2) -- (7, 0);
\node[font=\small, fill=white, align=center] at (6.5, -1.5) 
    {Initial PID\\$K_p^{meta}, K_d^{meta}$};

%============================================================================
% PHASE 3: RL Online Adaptation
%============================================================================
\begin{scope}[shift={(11, 2)}]
    % Phase框
    \node[phasebox=phase3color, minimum width=6cm, minimum height=9cm] at (0, 0) {};
    \node[font=\Large\bfseries, text=phase3color] at (0, 4.2) {Phase 3};
    \node[font=\large, text=phase3color!80] at (0, 3.7) {RL Adaptation};
    
    % RL流程（垂直）
    \node[box=blue!70, font=\small, minimum width=3cm] (obs) at (0, 2.5)
        {Observation\\$\bm{e}_q, \dot{\bm{e}}_q, \ddot{\bm{e}}_q$};
    
    \node[box=phase3color!80, font=\small, minimum width=3cm] (policy) at (0, 1.2)
        {PPO Policy\\$\pi_\theta(a|s)$};
    
    \node[box=green!70, font=\small, minimum width=3cm] (action) at (0, 0)
        {Action\\$\Delta K_p, \Delta K_d$};
    
    \node[box=purple!70, font=\small, minimum width=3cm] (env) at (0, -1.3)
        {Environment\\Robot Simulation};
    
    \node[box=orange!70, font=\small, minimum width=3cm] (reward) at (0, -2.6)
        {Reward\\$r = -\|\bm{e}_q\|$};
    
    % 前向连接
    \draw[arrow, blue] (obs) -- (policy);
    \draw[arrow, phase3color] (policy) -- (action);
    \draw[arrow, green!70] (action) -- (env);
    \draw[arrow, purple] (env) -- (reward);
    
    % 反馈循环
    \draw[arrow, dashed, orange, line width=2pt] (reward) -- (2, -2.6) -- (2, 2.5) -- (obs);
    \node[font=\tiny, fill=white] at (2.3, 0) {$s_{t+1}$};
    
    % 训练统计
    \node[font=\tiny, align=left, text=gray] at (0, -3.8)
        {\textbf{Training:}\\200k steps\\20 min\\+23.1\% gain};
\end{scope}

%============================================================================
% Final Result (右下角)
%============================================================================
\node[box=green!50, font=\Large\bfseries, minimum width=5cm, minimum height=2cm, ultra thick] at (11, -5.5)
{
    \textbf{Final Performance}\\[0.2cm]
    \large Franka Panda: \textcolor{red}{\textbf{5.37°}}\\
    \large Laikago: \textcolor{red}{\textbf{7.67°}}
};

% 箭头指向最终结果
\draw[bigarrow, phase3color] (11, -1) -- (11, -4);
\node[font=\small, fill=white, align=center] at (11.8, -2.5) {Adapted\\PID};

%============================================================================
% 时间线 (底部)
%============================================================================
\draw[ultra thick, ->] (-9, -8) -- (13, -8);
\node[font=\small] at (-9, -8.5) {Start};
\node[font=\small] at (13, -8.5) {Deployment};

% 时间标注
\node[fill=phase1color!30, rounded corners, font=\scriptsize, minimum width=2cm] at (-8, -9.2)
    {17 min\\303 robots};
\draw[dashed] (-8, -8) -- (-8, -8.8);

\node[fill=phase2color!30, rounded corners, font=\scriptsize, minimum width=2cm] at (0, -9.2)
    {8 min\\Train Meta-PID};
\draw[dashed] (0, -8) -- (0, -8.8);

\node[fill=phase3color!30, rounded corners, font=\scriptsize, minimum width=2cm] at (8, -9.2)
    {20 min\\RL Training};
\draw[dashed] (8, -8) -- (8, -8.8);

\node[fill=green!30, rounded corners, font=\scriptsize\bfseries, minimum width=2cm] at (12, -9.2)
    {\textbf{Total: 45 min}\\Ready to deploy};
\draw[dashed, green, ultra thick] (12, -8) -- (12, -8.8);

%============================================================================
% 关键创新点标注 (左下角)
%============================================================================
\node[draw, ultra thick, rounded corners=10pt, fill=yellow!20, text width=6cm, align=left,
      font=\scriptsize, drop shadow] at (-8, -11)
{
    \textbf{Key Innovations:}\\[0.1cm]
    \textcolor{phase1color}{■} \textbf{Physics-Based Data Augmentation:} 3→303 robots\\[0.05cm]
    \textcolor{phase2color}{■} \textbf{Hierarchical Meta-Learning:} Fast cross-platform\\[0.05cm]
    \textcolor{phase3color}{■} \textbf{Online RL Adaptation:} Real-time adjustment\\[0.05cm]
    \textcolor{orange}{■} \textbf{Hybrid Optimization:} DE + Nelder-Mead for GT\\[0.05cm]
    \textcolor{green!70!black}{■} \textbf{End-to-End:} 45 minutes from data to deployment
};

%============================================================================
% 性能对比 (右下角)
%============================================================================
\node[draw, ultra thick, rounded corners=10pt, fill=blue!10, text width=6cm, align=left,
      font=\scriptsize, drop shadow] at (4, -11)
{
    \textbf{Performance Comparison:}\\[0.1cm]
    \begin{tabular}{lcc}
        \textbf{Method} & \textbf{MAE} & \textbf{Time}\\
        \hline
        Heuristic & 35.2° & 0 min\\
        Pure Meta-PID & 7.08° & 8 min\\
        \textbf{Meta+RL (Ours)} & \textbf{5.37°} & \textbf{28 min}\\
    \end{tabular}\\[0.1cm]
    \textcolor{red}{\textbf{+84.7\% vs Heuristic}}\\
    \textcolor{red}{\textbf{+24.1\% vs Pure Meta-Learning}}
};

\end{tikzpicture}
\end{document}

