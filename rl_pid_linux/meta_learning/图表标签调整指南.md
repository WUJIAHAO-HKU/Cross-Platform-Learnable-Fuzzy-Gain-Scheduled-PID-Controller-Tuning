# 📊 图表标签位置调整指南

## 🎯 概述

本指南说明如何调整 `disturbance_comparison_final.png` 中改进百分比标签的位置和大小。

---

## 🔧 可调参数

### 1. `--fontsize` (字体大小)
- **默认值**: 9
- **作用**: 控制改进百分比标签的字体大小
- **建议范围**: 7-11

**示例**:
```bash
# 减小字体（更紧凑）
python plot_with_seed_statistics.py --fontsize 8

# 增大字体（更醒目）
python plot_with_seed_statistics.py --fontsize 10
```

---

### 2. `--offset_factor` (偏移因子)
- **默认值**: 2.5
- **作用**: 控制子图(a)(b)(c)中改进曲线标签与曲线点的垂直距离
- **建议范围**: 1.5-4.0
- **效果**: 
  - 值越大，标签距离曲线点越远（避免重叠）
  - 值越小，标签距离曲线点越近（更紧凑）

**示例**:
```bash
# 标签靠近曲线
python plot_with_seed_statistics.py --offset_factor 2.0

# 标签远离曲线（当改进值很大时推荐）
python plot_with_seed_statistics.py --offset_factor 3.5
```

---

### 3. `--y_margin_factor` (Y轴倍数)
- **默认值**: 1.15
- **作用**: 控制子图(d)中改进标签相对于柱子高度的位置
- **建议范围**: 1.10-1.25
- **效果**:
  - 值越大，标签位置越高（避免与误差条重叠）
  - 值越小，标签位置越低（更紧凑）

**计算公式**: `标签Y位置 = max(柱子高度+误差条) × y_margin_factor`

**示例**:
```bash
# 标签紧贴误差条顶部（推荐）
python plot_with_seed_statistics.py --y_margin_factor 1.15

# 标签稍微远离误差条
python plot_with_seed_statistics.py --y_margin_factor 1.20
```

---

## 🎨 推荐配置

### 方案1: 紧凑型（适合论文）
```bash
python plot_with_seed_statistics.py \
    --seed_results seed_search_results.json \
    --n_episodes 20 \
    --output disturbance_comparison_final.png \
    --fontsize 8 \
    --offset_factor 2.0 \
    --y_margin_factor 1.2
```

### 方案2: 平衡型（默认推荐）⭐
```bash
python plot_with_seed_statistics.py \
    --seed_results seed_search_results.json \
    --n_episodes 20 \
    --output disturbance_comparison_final.png \
    --fontsize 9 \
    --offset_factor 2.5 \
    --y_margin_factor 1.15
```

**注意**: v2.0版本新增智能标签定位功能，会自动调整极端值的偏移量，避免超出边界。

### 方案3: 宽松型（适合演示PPT）
```bash
python plot_with_seed_statistics.py \
    --seed_results seed_search_results.json \
    --n_episodes 20 \
    --output disturbance_comparison_final.png \
    --fontsize 10 \
    --offset_factor 3.5 \
    --y_margin_factor 1.3
```

---

## 🐛 问题诊断

### 问题1: 标签超出图表顶部（如+19.2%）

**症状**: 子图(b)的标签被截断

**解决方案**:
```bash
# 方法1: 增大偏移因子（推荐）
python plot_with_seed_statistics.py --offset_factor 3.0

# 方法2: 减小字体
python plot_with_seed_statistics.py --fontsize 8 --offset_factor 3.0

# 方法3: 组合调整
python plot_with_seed_statistics.py --fontsize 8.5 --offset_factor 2.8
```

**原理**: 代码会自动扩展Y轴范围以适应标签，但需要合理的偏移因子。

---

### 问题2: 子图(d)标签与误差条重叠

**症状**: 改进百分比标签覆盖在误差条上

**解决方案**:
```bash
# 增大Y轴倍数
python plot_with_seed_statistics.py --y_margin_factor 1.3
```

---

### 问题3: 标签之间相互遮挡

**症状**: 相邻的改进标签重叠

**解决方案**:
```bash
# 方法1: 减小字体
python plot_with_seed_statistics.py --fontsize 8

# 方法2: 增大偏移（让标签更分散）
python plot_with_seed_statistics.py --offset_factor 3.0
```

---

## 📐 技术细节

### 子图(a)(b)(c)的标签定位逻辑

```python
# 正值：标签在点上方
if improvement > 0:
    y_offset = improvement + offset_factor
    vertical_align = 'bottom'

# 负值：标签在点下方
else:
    y_offset = improvement - offset_factor
    vertical_align = 'top'

# 自动调整Y轴范围
y_max = max(all_improvements) + offset_factor + 2
y_min = min(all_improvements) - offset_factor - 2
```

### 子图(d)的标签定位逻辑

```python
# 考虑误差条的高度
max_height_with_error = max(mean + std for mean, std in zip(means, stds))

# 标签位置
label_y_position = max_height_with_error * y_margin_factor
```

---

## 🧪 快速测试

```bash
cd /home/wujiahao/基于强化学习的模型预测控制动力学模型误差在线补偿方法研究/rl_pid_linux/meta_learning

# 测试不同配置（快速生成）
for offset in 2.0 2.5 3.0 3.5; do
    python plot_with_seed_statistics.py \
        --offset_factor $offset \
        --output "test_offset_${offset}.png"
    echo "✅ 生成: test_offset_${offset}.png"
done

# 对比查看
ls -lh test_offset_*.png
```

---

## ✅ 当前推荐配置（基于种子51）

针对你当前的数据（最大改进+19.2%，最大负改进-6.7%），推荐：

```bash
python plot_with_seed_statistics.py \
    --seed_results seed_search_results.json \
    --n_episodes 20 \
    --output disturbance_comparison_final.png \
    --fontsize 9 \
    --offset_factor 2.5 \
    --y_margin_factor 1.15
```

**原因**:
- `offset_factor=2.5`: 使用智能偏移系统，极端值会自动减小偏移（0.6倍）
- `fontsize=9`: 保持可读性
- `y_margin_factor=1.15`: 子图(d)标签更靠近柱子，避免距离过远

**智能偏移特性（v2.0新增）**:
- 对于接近极值的标签（>80%最大值），自动使用0.6倍偏移
- 子图b：第一个点（13.2%）自动放置在点下方，避免与图例重叠
- 自动扩展Y轴范围，确保所有标签都在可见区域内

---

## 📝 查看当前配置

```bash
python plot_with_seed_statistics.py --help
```

---

## 🎓 实用技巧

1. **快速迭代**: 修改参数后立即重新生成，使用图片查看器的自动刷新功能
2. **批量测试**: 使用上面的循环脚本测试多个配置
3. **记录最佳值**: 找到满意的配置后，记录参数以便后续使用
4. **论文最终版**: 建议使用稍大的`offset_factor`（3.0-3.5）确保所有标签清晰可见

---

**更新时间**: 2025-11-01  
**版本**: 1.0

